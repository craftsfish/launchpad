{% extends "base.html" %}

{% block header %}换仓{% endblock %}

{% block extra_script %}
	<script>
		function on_item_retrieved(data,status){
			items = eval("("+data+")");
			total = jQuery("input[name=\"form-TOTAL_FORMS\"]");
			var p = parseInt(total.attr("value"))
			total.attr({"value": p+items.length});
			var repo_f = jQuery("#id_repository_f").val();
			var str_repo_f = jQuery("#id_repository_f option[value="+repo_f+"]").text();
			var stat_f = jQuery("#id_status_f").val();
			var str_stat_f = jQuery("#id_status_f option[value="+stat_f+"]").text();
			var repo_t = jQuery("#id_repository_t").val();
			var str_repo_t = jQuery("#id_repository_t option[value="+repo_t+"]").text();
			var stat_t = jQuery("#id_status_t").val();
			var str_stat_t = jQuery("#id_status_t option[value="+stat_t+"]").text();
			for (i in items)
			{
				n = str_repo_f + "." + str_stat_f + " -> " + str_repo_t + "." + str_stat_t + ": " + items[i].str
				j = p + parseInt(i)
				r = jQuery("<tr></tr>");
				q = 1
				jQuery("#item_table").prepend(r);
				r.append(`<td><input  type="checkbox" name=form-${j}-check checked/></td>
							<td>${n}</td>
							<td><input type="number" name=form-${j}-quantity value=${q} /></td>
							<input type="hidden" name=form-${j}-id value=${items[i].id} />
							<input type="hidden" name=form-${j}-repository_f value=${repo_f} />
							<input type="hidden" name=form-${j}-status_f value=${stat_f} />
							<input type="hidden" name=form-${j}-repository_t value=${repo_t} />
							<input type="hidden" name=form-${j}-status_t value=${stat_t} />`);
			}
		};
	</script>
	{% include 'vault/script_item_filter.html' %}
{% endblock %}

{% block content %}
<div class="col col-lg-12">
	<label>+交易品</label>
	<input id="item_keyword" type="text"/>
	<form class="border border-dark" action="" method="post">
		{% csrf_token %}
		<div class = "row">
			<div class="col col-lg-6">
				{{ form.as_p }}
				<input type="submit" value="提交"/>
			</div>

			<div class="col col-lg-6">
				<table cellpadding="4" border="1">
				{{ formset.management_form }}
				<tbody id="item_table">
				</tbody>
					{% for form in formset %}
						<tr>
							<td>{{form.check}}</td>
							<td>{{form.label}}</td>
							<td>{{form.quantity}}</td>
							{% for hidden in form.hidden_fields %}
							{{ hidden }}
							{% endfor %}
						</tr>
					{% endfor %}
				</table>
			</div>
		</div>
	</form>
</div>
{% endblock %}
