{% extends "base.html" %}

{% block extra_script %}
	<script>
		function merge(){
			fid = jQuery("#id_task").text();
			tid = jQuery("#id_key").val();
			if (tid != "")
				window.location.href = `/vault/task/${fid}/merge/to/${tid}/`;
		}
	</script>
{% endblock %}

{% block header %}任务详情{% endblock %}

{% block content %}
<div class="col-sm-auto">
	<table cellpadding="4" border="1">
		<tr>
			<th></th>
			<th></th>
			<th>任务编号</th>
			<th>任务描述</th>
			{% if order %}
			<th>订单编号</th>
			<th>订单状态</th>
			<th>刷单平台</th>
			<th>刷单自动结算</th>
			<th>发货仓库</th>
			<th>销售额</th>
			{% endif %}
			{% for n, u in private.governor %}
				<th></th>
			{% endfor %}
		</tr>
		<tr>
			<td><a href="{% url 'task_previous' object.id %}">前一任务</a></td>
			<td><a href="{% url 'task_next' object.id %}">后一任务</a></td>
			<td id="id_task">{{object.id}}</td>
			<td>{{object.desc}}</td>
			{% if order %}
			<td>{{order.oid}}</td>
			<td>{{order.status}}</td>
			<td>{{order.counterfeit}}</td>
			<td>{{order.counterfeit_auto_clear}}</td>
			<td>{{order.repository}}</td>
			<td>{{order.sale}}</td>
			{% endif %}
			{% for n, u in private.governor %}
				<td><a href={{u}}>{{n}}</a></td>
			{% endfor %}
			<td>
				<input type="text" id="id_key" />
				<a href="javascript:void(0);" onclick ="merge()">合并到任务</a>
			</td>
		</tr>
	</table>
	<br/>

	{% include 'vault/content/task_common.html' %}

	{% if uncleared or unsettled %}
	<table cellpadding="4" border="1">
		<tr>
			<th></th>
			<th>组织</th>
			<th>标的</th>
			<th>账户</th>
			<th>余额</th>
		</tr>
		{% for a, b in uncleared %}
		<tr>
			{% if not forloop.counter0 %}
			<td rowspan={{uncleared | length}}><a href={{private.clear_url}} %}">资金结算</a></td>
			{% endif %}
			<td>{{a.organization}}</td>
			<td>{{a.item}}</td>
			<td>{{a}}</td>
			<td>{{b}}</td>
		</tr>
		{% endfor %}
		{% for a, b in unsettled %}
		<tr>
			{% if not forloop.counter0 %}
			<td rowspan={{unsettled | length}}><a href={{private.settle_url}} %}">货物交割</a></td>
			{% endif %}
			<td>{{a.organization}}</td>
			<td>{{a.item}}</td>
			<td>{{a}}</td>
			<td>{{b}}</td>
		</tr>
		{% endfor %}
	</table>
	{% endif %}
	<br/>

	<table cellpadding="4" border="1">
	<tr>
		{% if private.governor %}
		<th></th>
		<th></th>
		<th></th>
		<th></th>
		{% endif %}
		<th>时间</th>
		<th>概述</th>
		<th>标的</th>
		<th colspan="{{detail_spans}}">详情</th>
	</tr>
	{% for t in trans %}
	<tr>
		{% if private.governor %}
		<td><a href="{% url 'transaction_duplicate' t.id %}">复制</a></td>
		<td><a href="{% url 'transaction_delete' t.id %}">删除</a></td>
		<td><a href="{% url 'transaction_revert' t.id %}">中和</a></td>
		<td><a href="{% url 'transaction_update' t.id %}">编辑</a></td>
		{% endif %}
		<td>{{t.time | date:"Y-m-d H:i:s" }}</td>
		<td>{{t.desc}}</td>
		{% for s in t.ss %}
		{% if not forloop.counter0 %}
			{% if t.is_money %}
			<td>{{s.account.item}}</td>
			{% else %}
			<td><a href="{% url 'commodity_detail' s.account.item.id %}">{{s.account.item}}</a></td>
			{% endif %}
		{% endif %}
		{% if private.governor %}
		<td align="left"><a href="{% url 'account_detail' s.account.uuid %}">{{s.account}}</a></td>
		{% else %}
		<td align="left">{{s.account}}</td>
		{% endif %}
		{% if t.is_money %}
			<td align="right">{{s.change | stringformat:"+.2f"}}</td>
		{% else %}
			<td align="right">{{s.change | stringformat:"+.0f"}}</td>
		{% endif %}
		{% endfor %}
	</tr>
	{% endfor %}
	</table>
</div>
{% endblock %}
