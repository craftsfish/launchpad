{% extends "base.html" %}

{% block header %}编辑交易{% endblock %}

{% block extra_script %}
	<script>
		function __f_add_account(aid, aname){
			p = jQuery("<div></div>");
			jQuery("#id_fieldset_for_splits").append(p);
			total = jQuery("#id_splits-TOTAL_FORMS");
			var i = parseInt(total.attr("value"))
			total.attr({"value": i+1});
			var change_name = `splits-${i}-change`
			var change_id = `id_splits-${i}-change`
			var del_id = `id_splits-${i}-DELETE`
			var del_name = `splits-${i}-DELETE`
			var account_name = `splits-${i}-account`
			var account_id = `id_splits-${i}-account`
			var split_name = `splits-${i}-id`
			var split_id = `id_splits-${i}-id`
			var transaction_name = `splits-${i}-transaction`
			var transaction_id = `id_splits-${i}-transaction`
			var transaction_value = jQuery("#id_transaction").text()
			p.append(`<label>${aname} : </label><tr><th></th><td><input type="number" name=${change_name} step="0.01" id=${change_id} /></td></tr><tr><th><label for=${del_id}>Delete:</label></th><td><input type="checkbox" name=${del_name} id=${del_id} /><input type="hidden" name=${account_name} value=${aid} id=${account_id} /><input type="hidden" name=${split_name} id=${split_id} /><input type="hidden" name=${transaction_name} value=${transaction_value} id=${transaction_id} /></td></tr>`);
		}

		jQuery(document).ready(function(){
			jQuery("button").click(function(){
				jQuery.post("/vault/account/",
					{
						organization: jQuery("#id_organization").val(),
						item: jQuery("#id_item").text(),
						csrfmiddlewaretoken: '{{ csrf_token  }}'
					},
					function(data,status){
						accounts = eval("("+data+")");
						p = jQuery("#id_filtered_accounts");
						p.empty();
						for (i in accounts)
						{
							b = jQuery("<button></button>").text("添加");
							p.append(b.attr({"onclick": "__f_add_account("+accounts[i].id+",'"+accounts[i].str+"')"}));
							p.append(jQuery("<label></label>").text(accounts[i].str));
							p.append("<br/>");
						}
					});
			});
			jQuery('#datetimepicker1').datetimepicker({
				format: 'YYYY-MM-DD HH:mm:ss',
			});
		});
	</script>
{% endblock %}

{% block content %}
<div class="col col-lg-6">
	{% if error %}
	<div class="alert alert-danger" role="alert">{{error}}</div>
	{% endif %}
	<label>交易编号: </label><label id="id_transaction">{{object.id}}</label>
	<br/>
	<label>标的编号: </label><label id="id_item">{{item.id}}</label>
	<form action="" method="post">
		{% csrf_token %}
		<fieldset>
			<legend>交易概要</legend>
			{{ form.non_field_errors }}
			{% for hidden in form.hidden_fields %}
				{{ hidden }}
			{% endfor %}
			<div class="fieldWrapper">
				{{ form.desc.errors }}
				{{ form.desc.label_tag }}
				{{ form.desc }}
			</div>
			<div class="fieldWrapper">
				{{ form.time.errors }}
				<div class="input-group date" id="datetimepicker1" data-target-input="nearest">
					{{ form.time.label_tag }}
					{{ form.time }}
					<div class="input-group-append" data-target="#datetimepicker1" data-toggle="datetimepicker">
						<div class="input-group-text"><i class="fa fa-calendar"></i></div>
					</div>
				</div>
			</div>
		</fieldset>

		{# formset for splits #}
		<fieldset id="id_fieldset_for_splits">
			<legend>交易明细</legend>
			{{ formset.management_form }}
			{% for form in formset %}
				<div>
					<label>{{form.account_display_name}} : </label>{{ form }}
				</div>
			{% endfor %}
		</fieldset>

		<input type="submit" value="提交" />
	</form>
</div>

<div class="col col-lg-6">
	{{account.as_p}}
	<button>查询账户</button>
	<div id="id_filtered_accounts">
	</div>
</div>
{% endblock %}
